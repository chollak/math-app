# üì∏ –†–µ–∑—é–º–µ: –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–∞–º–∏ –¥–ª—è –ï–ù–¢ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

## üéØ –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

### 1. **–ù–∏–∫–æ–≥–¥–∞ –Ω–µ —Ö—Ä–∞–Ω–∏—Ç–µ –æ—Ä–∏–≥–∏–Ω–∞–ª—ã –∫–∞–∫ –µ—Å—Ç—å**
```
‚ùå –ü–õ–û–•–û: –ó–∞–≥—Ä—É–∑–∏–ª–∏ 5MB —Ñ–æ—Ç–æ ‚Üí —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏ 5MB ‚Üí —Ä–∞–∑–¥–∞–µ–º 5MB –≤—Å–µ–º
‚úÖ –•–û–†–û–®–û: –ó–∞–≥—Ä—É–∑–∏–ª–∏ 5MB ‚Üí —Å–∂–∞–ª–∏ –¥–æ 200KB WebP ‚Üí —Ä–∞–∑–¥–∞–µ–º 200KB
```

### 2. **–í—Å–µ–≥–¥–∞ —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ –≤–µ—Ä—Å–∏–∏**
```
–û–¥–Ω–æ —Ñ–æ—Ç–æ ‚Üí 4 –≤–µ—Ä—Å–∏–∏:
‚îú‚îÄ‚îÄ thumbnail (200x200, ~30KB)   ‚Üí –¥–ª—è —Å–ø–∏—Å–∫–æ–≤
‚îú‚îÄ‚îÄ medium (800x600, ~150KB)     ‚Üí –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
‚îú‚îÄ‚îÄ large (1920x1080, ~500KB)    ‚Üí –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞
‚îî‚îÄ‚îÄ original (–æ—Ä–∏–≥–∏–Ω–∞–ª)          ‚Üí –¥–ª—è –∞—Ä—Ö–∏–≤–∞
```

### 3. **–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ, –∞ –Ω–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ**
```javascript
// ‚ùå –û–ü–ê–°–ù–û
if (filename.endsWith('.jpg')) { }

// ‚úÖ –ë–ï–ó–û–ü–ê–°–ù–û
const fileType = await fileTypeFromBuffer(buffer);
if (fileType.mime !== 'image/jpeg') {
  throw new Error('Invalid file');
}
```

### 4. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è production**
```
–õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ ‚Üí –¢–æ–ª—å–∫–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
–û–±–ª–∞—á–Ω–æ–µ (S3/R2) ‚Üí Production

–ü–æ—á–µ–º—É?
- –§–∞–π–ª—ã –Ω–µ —Ç–µ—Ä—è—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ —Å–µ—Ä–≤–µ—Ä–∞
- CDN –¥–ª—è –±—ã—Å—Ç—Ä–æ–π —Ä–∞–∑–¥–∞—á–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π backup
- –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å
```

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (—É–ø—Ä–æ—â–µ–Ω–Ω–æ)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–æ—Ç–æ 5MB
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Backend (Express)           ‚îÇ
‚îÇ  1. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—É—é   ‚îÇ
‚îÇ  2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Image Service (Sharp)       ‚îÇ
‚îÇ  1. –£–±—Ä–∞—Ç—å EXIF              ‚îÇ
‚îÇ  2. –°–æ–∑–¥–∞—Ç—å 4 –≤–µ—Ä—Å–∏–∏         ‚îÇ
‚îÇ  3. –°–∂–∞—Ç—å –≤ WebP             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
       ‚ñº         ‚ñº         ‚ñº         ‚ñº
    thumb.webp med.webp large.webp orig.jpg
     (30KB)   (150KB)   (500KB)   (4MB)
       ‚îÇ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –•—Ä–∞–Ω–∏–ª–∏—â–µ                   ‚îÇ
‚îÇ  ‚Ä¢ Local: /uploads/          ‚îÇ
‚îÇ  ‚Ä¢ Cloud: S3/R2              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  CDN (Cloudflare)            ‚îÇ
‚îÇ  –†–∞–∑–¥–∞–µ—Ç —Ñ–∞–π–ª—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º ‚îÇ
‚îÇ  —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üìä –°—Ö–µ–º–∞ –ë–î

### –°—Ç–∞—Ä—ã–π –ø–æ–¥—Ö–æ–¥ (–≤–∞—à —Ç–µ–∫—É—â–∏–π):
```sql
questions
‚îú‚îÄ‚îÄ id: 1
‚îú‚îÄ‚îÄ question: "–í–æ–ø—Ä–æ—Å"
‚îî‚îÄ‚îÄ photos: '["photo1-123.jpg", "photo2-456.jpg"]'
     ‚îî‚îÄ> JSON –º–∞—Å—Å–∏–≤ –∏–º–µ–Ω —Ñ–∞–π–ª–æ–≤
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- –ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–∞–∑–º–µ—Ä–∞—Ö
- –ù–µ—Ç –≤–µ—Ä—Å–∏–π (thumbnail/medium/large)
- –ù–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (–∫—Ç–æ –∑–∞–≥—Ä—É–∑–∏–ª, –∫–æ–≥–¥–∞)
- –ù–µ–ª—å–∑—è –±—ã—Å—Ç—Ä–æ –Ω–∞–π—Ç–∏ –≤—Å–µ —Ñ–∞–π–ª—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### –ù–æ–≤—ã–π –ø–æ–¥—Ö–æ–¥ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π):
```sql
files
‚îú‚îÄ‚îÄ id: 1
‚îú‚îÄ‚îÄ filename: "q123_1_thumb_abc.webp"
‚îú‚îÄ‚îÄ entity_type: "question"
‚îú‚îÄ‚îÄ entity_id: 123
‚îú‚îÄ‚îÄ version: "thumbnail"
‚îú‚îÄ‚îÄ file_size: 30720
‚îú‚îÄ‚îÄ width: 200
‚îú‚îÄ‚îÄ height: 200
‚îú‚îÄ‚îÄ storage_provider: "r2"
‚îú‚îÄ‚îÄ cdn_url: "https://cdn.example.com/q123_1_thumb_abc.webp"
‚îî‚îÄ‚îÄ file_group: "q123_1"  ‚Üê –°–≤—è–∑—ã–≤–∞–µ—Ç –≤–µ—Ä—Å–∏–∏ –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞

files
‚îú‚îÄ‚îÄ id: 2
‚îú‚îÄ‚îÄ filename: "q123_1_medium_abc.webp"
‚îú‚îÄ‚îÄ entity_type: "question"
‚îú‚îÄ‚îÄ entity_id: 123
‚îú‚îÄ‚îÄ version: "medium"
‚îú‚îÄ‚îÄ file_group: "q123_1"  ‚Üê –¢–∞ –∂–µ –≥—Ä—É–ø–ø–∞!
‚îî‚îÄ‚îÄ ...

files
‚îú‚îÄ‚îÄ id: 3
‚îú‚îÄ‚îÄ filename: "q123_1_large_abc.webp"
‚îú‚îÄ‚îÄ version: "large"
‚îú‚îÄ‚îÄ file_group: "q123_1"
‚îî‚îÄ‚îÄ ...
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ü–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞–∂–¥–æ–º —Ñ–∞–π–ª–µ
- ‚úÖ –£–¥–æ–±–Ω—ã–π –ø–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
- ‚úÖ Audit log (–∫—Ç–æ –∏ –∫–æ–≥–¥–∞ –∑–∞–≥—Ä—É–∑–∏–ª)
- ‚úÖ –õ–µ–≥–∫–æ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å local –Ω–∞ S3
- ‚úÖ –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å watermark, —Ç–µ–≥–∏ –∏ —Ç.–¥.

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
```bash
npm install sharp file-type @aws-sdk/client-s3 @aws-sdk/s3-request-presigner
```

### –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ .env
```env
# –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (–¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
CLOUD_STORAGE_ENABLED=false

# –û–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (–¥–ª—è production)
CLOUD_STORAGE_ENABLED=true
S3_ENDPOINT=https://YOUR_ACCOUNT_ID.r2.cloudflarestorage.com
S3_REGION=auto
S3_BUCKET_NAME=ent-app-images
S3_ACCESS_KEY_ID=your_key
S3_SECRET_ACCESS_KEY=your_secret
```

### –®–∞–≥ 3: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–¥–µ
```javascript
const imageService = require('./services/image.service');

// –í –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ —Å–æ–∑–¥–∞–Ω–∏—è –≤–æ–ø—Ä–æ—Å–∞
app.post('/api/questions', uploadQuestionPhotos, async (req, res) => {
  // 1. –°–æ–∑–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –≤ –ë–î
  const question = await Question.create({ ... });

  // 2. –û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
  if (req.files) {
    const files = [
      ...req.files.photo1 || [],
      ...req.files.photo2 || [],
      ...req.files.photo3 || []
    ];

    const processedPhotos = await imageService.processMultipleImages(
      files,
      `q${question.id}`
    );

    // 3. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–∞—Ö
    // TODO: —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ —Ç–∞–±–ª–∏—Ü—É files
  }

  res.json({ id: question.id, photos: processedPhotos });
});
```

### –®–∞–≥ 4: –†–∞–∑–¥–∞—á–∞ —Ñ–∞–π–ª–æ–≤
```javascript
// –ü—Ä–æ—Å—Ç–æ–π –≤–∞—Ä–∏–∞–Ω—Ç (—á–µ—Ä–µ–∑ Express)
app.get('/api/files/:filename', (req, res) => {
  const filePath = path.join(uploadsDir, req.params.filename);
  res.sendFile(filePath);
});

// –£–ª—É—á—à–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç (—Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º)
app.get('/api/files/:filename', async (req, res) => {
  const { filename } = req.params;
  const filePath = path.join(uploadsDir, filename);

  const stats = await fs.stat(filePath);
  const etag = `"${stats.mtime.getTime()}-${stats.size}"`;

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞
  if (req.headers['if-none-match'] === etag) {
    return res.status(304).end(); // Not Modified
  }

  res.set({
    'ETag': etag,
    'Cache-Control': 'public, max-age=31536000, immutable'
  });

  res.sendFile(filePath);
});
```

---

## üìà –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–æ–≤

| –ê—Å–ø–µ–∫—Ç | –¢–µ–∫—É—â–∏–π (–≤–∞—à) | –£–ª—É—á—à–µ–Ω–Ω—ã–π |
|--------|---------------|------------|
| **–•—Ä–∞–Ω–µ–Ω–∏–µ** | JSON –º–∞—Å—Å–∏–≤ | –¢–∞–±–ª–∏—Ü–∞ files |
| **–í–µ—Ä—Å–∏–∏** | –ù–µ—Ç | 4 –≤–µ—Ä—Å–∏–∏ (thumb/med/large/orig) |
| **–§–æ—Ä–º–∞—Ç** | JPEG/PNG (–±–æ–ª—å—à–æ–π) | WebP (–Ω–∞ 30% –º–µ–Ω—å—à–µ) |
| **–í–∞–ª–∏–¥–∞—Ü–∏—è** | MIME type | Magic bytes + MIME |
| **EXIF** | –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è (—Ä–∏—Å–∫ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏) | –£–¥–∞–ª—è–µ—Ç—Å—è |
| **–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ** | –ù–µ—Ç | –†–∞–∑–º–µ—Ä, —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ, –¥–∞—Ç–∞ |
| **–û–±–ª–∞–∫–æ** | –ù–µ—Ç | S3/R2 –ø–æ–¥–¥–µ—Ä–∂–∫–∞ |
| **CDN** | –ù–µ—Ç | Cloudflare CDN |
| **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** | –ù–µ—Ç | ETag, Cache-Control |

---

## üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å (–¥–ª—è 10,000 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)

### –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ:
- –°–µ—Ä–≤–µ—Ä —Å 100GB SSD: ~$20/–º–µ—Å—è—Ü
- Bandwidth 2TB: ~$20/–º–µ—Å—è—Ü
- **–ò—Ç–æ–≥–æ: $40/–º–µ—Å—è—Ü**
- ‚ùå –ù–µ—Ç —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚ùå –ú–µ–¥–ª–µ–Ω–Ω–∞—è —Ä–∞–∑–¥–∞—á–∞ (–±–µ–∑ CDN)

### Cloudflare R2 + CDN:
- –•—Ä–∞–Ω–∏–ª–∏—â–µ 100GB: $1.50/–º–µ—Å—è—Ü
- Operations: ~$5/–º–µ—Å—è—Ü
- Egress (CDN): **$0** (–±–µ—Å–ø–ª–∞—Ç–Ω–æ!)
- **–ò—Ç–æ–≥–æ: $6.50/–º–µ—Å—è—Ü**
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π backup
- ‚úÖ –ë—ã—Å—Ç—Ä–∞—è —Ä–∞–∑–¥–∞—á–∞ (CDN)
- ‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å

**–í—ã–≤–æ–¥:** R2 –¥–µ—à–µ–≤–ª–µ –≤ 6 —Ä–∞–∑ –∏ –ª—É—á—à–µ!

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å - Checklist

- [x] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–∞ –ø–æ magic bytes (–Ω–µ —Ç–æ–ª—å–∫–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ)
- [x] –£–¥–∞–ª–µ–Ω–∏–µ EXIF –¥–∞–Ω–Ω—ã—Ö (GPS –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã, –º–æ–¥–µ–ª—å –∫–∞–º–µ—Ä—ã)
- [x] –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ (< 10MB)
- [x] –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è (< 4000x4000px)
- [x] –ó–∞—â–∏—Ç–∞ –æ—Ç Path Traversal (`../../../etc/passwd`)
- [x] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∏–º–µ–Ω (–Ω–µ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞)
- [x] –í–∞–ª–∏–¥–∞—Ü–∏—è Content-Type
- [ ] Rate limiting (–º–∞–∫—Å. 10 –∑–∞–≥—Ä—É–∑–æ–∫ –≤ –º–∏–Ω—É—Ç—É)
- [ ] Virus scanning (ClamAV –¥–ª—è production)
- [ ] Watermark (–∑–∞—â–∏—Ç–∞ –∞–≤—Ç–æ—Ä—Å–∫–∏—Ö –ø—Ä–∞–≤)

---

## üìù –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏

### ‚ùå –û—à–∏–±–∫–∞ 1: –†–∞–∑–¥–∞—á–∞ —á–µ—Ä–µ–∑ Node.js
```javascript
// –ü–õ–û–•–û
app.get('/files/:name', (req, res) => {
  res.sendFile(filePath); // Node.js –Ω–µ –¥–ª—è —ç—Ç–æ–≥–æ!
});
```

**–†–µ—à–µ–Ω–∏–µ:** Nginx –∏–ª–∏ CDN
```nginx
# nginx.conf
location /uploads/ {
  alias /var/www/uploads/;
  expires 1y;
  add_header Cache-Control "public, immutable";
}
```

### ‚ùå –û—à–∏–±–∫–∞ 2: –ó–∞–≥—Ä—É–∑–∫–∞ –±–µ–∑ –ª–∏–º–∏—Ç–æ–≤
```javascript
// –ü–õ–û–•–û - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∑–∞–≥—Ä—É–∑–∏—Ç—å 1GB —Ñ–∞–π–ª
app.post('/upload', upload.single('photo'), ...);
```

**–†–µ—à–µ–Ω–∏–µ:**
```javascript
const upload = multer({
  limits: {
    fileSize: 10 * 1024 * 1024, // 10MB
    files: 5
  }
});
```

### ‚ùå –û—à–∏–±–∫–∞ 3: –•—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã—Ö –∏–º–µ–Ω
```javascript
// –ü–õ–û–•–û
const filename = file.originalname; // "–º–æ–π —Ñ–∞–π–ª (–∫–æ–ø–∏—è).jpg"
```

**–†–µ—à–µ–Ω–∏–µ:**
```javascript
const filename = `${Date.now()}_${crypto.randomBytes(8).toString('hex')}.jpg`;
```

---

## üéì –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### 1. Watermark (–∑–∞—â–∏—Ç–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞)
```javascript
await sharp(inputPath)
  .composite([{
    input: 'watermark.png',
    gravity: 'southeast'
  }])
  .toFile(outputPath);
```

### 2. Blur –¥–ª—è NSFW –∫–æ–Ω—Ç–µ–Ω—Ç–∞
```javascript
await sharp(inputPath)
  .blur(20)
  .toFile(blurredPath);
```

### 3. Face detection (–¥–ª—è –∞–≤—Ç–æ–∫—Ä–æ–ø–∞)
```javascript
const faces = await faceapi.detectAllFaces(image);
const crop = calculateCropArea(faces);
await sharp(inputPath).extract(crop).toFile(outputPath);
```

### 4. Optical Character Recognition (OCR)
```javascript
// –î–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
const text = await Tesseract.recognize(imagePath, 'rus+kaz');
```

---

## üìö –ü–æ–ª–µ–∑–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [Sharp Documentation](https://sharp.pixelplumbing.com/) - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- [Cloudflare R2 Docs](https://developers.cloudflare.com/r2/) - –æ–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
- [WebP vs JPEG](https://developers.google.com/speed/webp/docs/webp_study) - —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–æ–≤
- [Image Optimization Guide](https://web.dev/fast/#optimize-your-images) - Google Web.dev

---

## ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –≤–∞—à–µ–≥–æ –ï–ù–¢ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

### –§–∞–∑–∞ 1: MVP (—Å–µ–π—á–∞—Å)
- [x] –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
- [ ] Image Service (–æ–±—Ä–∞–±–æ—Ç–∫–∞)
- [ ] 4 –≤–µ—Ä—Å–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- [ ] WebP —Ñ–æ—Ä–º–∞—Ç

### –§–∞–∑–∞ 2: Beta (—á–µ—Ä–µ–∑ 1-2 –º–µ—Å—è—Ü–∞)
- [ ] Cloudflare R2
- [ ] CDN —Ä–∞–∑–¥–∞—á–∞
- [ ] –¢–∞–±–ª–∏—Ü–∞ files –≤ –ë–î
- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤

### –§–∞–∑–∞ 3: Production (—á–µ—Ä–µ–∑ 3-4 –º–µ—Å—è—Ü–∞)
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π backup
- [ ] Monitoring (—Ä–∞–∑–º–µ—Ä —Ö—Ä–∞–Ω–∏–ª–∏—â–∞)
- [ ] Watermark
- [ ] Video support (–¥–ª—è –≤–∏–¥–µ–æ-—É—Ä–æ–∫–æ–≤)

---

## ü§î FAQ

**Q: –ù—É–∂–Ω–æ –ª–∏ —Å—Ä–∞–∑—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ?**
A: –ù–µ—Ç, –¥–ª—è MVP –ø–æ–¥–æ–π–¥–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ–µ. –ù–æ –ø–ª–∞–Ω–∏—Ä—É–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é –Ω–∞ –æ–±–ª–∞–∫–æ –¥–ª—è production.

**Q: –ö–∞–∫–æ–π —Ñ–æ—Ä–º–∞—Ç –ª—É—á—à–µ - WebP –∏–ª–∏ JPEG?**
A: WebP –Ω–∞ 30% –º–µ–Ω—å—à–µ –ø—Ä–∏ —Ç–æ–º –∂–µ –∫–∞—á–µ—Å—Ç–≤–µ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ WebP –¥–ª—è –≤—Å–µ–≥–æ, –∫—Ä–æ–º–µ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞.

**Q: –ö–∞–∫ –±—ã—Å—Ç—Ä–æ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ñ–∞–π–ª—ã –≤–æ–ø—Ä–æ—Å–∞?**
A: –° –Ω–æ–≤–æ–π —Å—Ö–µ–º–æ–π –ë–î:
```sql
DELETE FROM files WHERE entity_type = 'question' AND entity_id = 123;
```

**Q: –ú–æ–∂–Ω–æ –ª–∏ —Ö—Ä–∞–Ω–∏—Ç—å PDF —Ñ–∞–π–ª—ã?**
A: –î–∞! –ü—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤—å—Ç–µ MIME type –≤ –≤–∞–ª–∏–¥–∞—Ü–∏—é:
```javascript
const allowedTypes = ['image/jpeg', 'image/png', 'application/pdf'];
```

**Q: –ö–∞–∫ –∑–∞—â–∏—Ç–∏—Ç—å—Å—è –æ—Ç –≤–∏—Ä—É—Å–æ–≤ –≤ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö?**
A: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ ClamAV –∏–ª–∏ –æ–±–ª–∞—á–Ω—ã–π —Å–µ—Ä–≤–∏—Å (VirusTotal API) –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.

---

## üéØ –ò—Ç–æ–≥–æ–≤—ã–π —á–µ–∫–ª–∏—Å—Ç

–ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –≤ production —É–±–µ–¥–∏—Ç–µ—Å—å:

- [ ] Image Service —Ä–∞–±–æ—Ç–∞–µ—Ç (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–µ—Ä—Å–∏–π)
- [ ] EXIF –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª—è—é—Ç—Å—è
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ magic bytes
- [ ] –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞/—Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
- [ ] Cloudflare R2 –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] CDN —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ (Cache-Control)
- [ ] –¢–∞–±–ª–∏—Ü–∞ files —Å–æ–∑–¥–∞–Ω–∞
- [ ] Backup –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤–∫–ª—é—á–µ–Ω
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞
- [ ] –¢–µ—Å—Ç—ã –Ω–∞–ø–∏—Å–∞–Ω—ã

---

–£–¥–∞—á–∏ —Å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–æ–π –ï–ù–¢ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è! üöÄ
