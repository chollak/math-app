<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Добавление вопроса</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  <style>
    .preview {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    .crop-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .crop-modal img {
      max-width: 90%;
      max-height: 80%;
    }
    pre {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 5px;
      font-size: 14px;
    }
    .suboptions-container {
      margin-left: 20px;
      margin-top: 10px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 5px;
      border-left: 3px solid #007bff;
    }
    .suboption-item {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }
    .suboption-item input[type="text"] {
      flex: 1;
      margin-right: 10px;
    }
    .suboption-item input[type="checkbox"] {
      margin-left: 10px;
    }
    .option-group {
      border: 1px solid #e9ecef;
      padding: 10px;
      border-radius: 5px;
      background: #fff;
    }
  </style>
</head>
<body class="p-4">
  <div class="container">
    <h3>Добавление вопроса</h3>

    <form id="questionForm" class="mt-3">
      <div class="mb-3">
        <label class="form-label">Вопрос</label>
        <input type="text" name="question" class="form-control" required>
      </div>

      <div class="mb-3">
        <label class="form-label">Язык</label>
        <select name="language" class="form-select" required>
          <option value="ru">Русский</option>
          <option value="kz">Казахский</option>
        </select>
      </div>

      <div class="mb-3">
        <label class="form-label">Уровень</label>
        <input type="number" name="level" class="form-control" min="1" max="5">
      </div>

      <div class="mb-3">
        <label class="form-label">Ответ (например: A, AB, ABCD)</label>
        <input type="text" name="answer" pattern="[A-H]+" title="Только буквы A–H без пробелов" class="form-control" required>
      </div>

      <div class="mb-3">
        <label class="form-label">Тема (topic)</label>
        <select name="topic" class="form-select" required>
          <option value="RAD">RAD — Действия с радикалами</option>
          <option value="POW">POW — Абсолютные величины</option>
          <option value="TRG">TRG — Тригонометрия</option>
          <option value="ALG">ALG — Алгебраические выражения</option>
          <option value="EQS">EQS — Уравнения</option>
          <option value="TRE">TRE — Тригонометрические уравнения</option>
          <option value="EXL">EXL — Показательные и логарифмические уравнения</option>
          <option value="SYS">SYS — Системы уравнений</option>
          <option value="SYM">SYM — Системы тригонометрических уравнений</option>
          <option value="INE">INE — Неравенства</option>
          <option value="INS">INS — Системы неравенств</option>
          <option value="PRG">PRG — Прогрессии</option>
          <option value="CAL">CAL — Математический анализ</option>
          <option value="GEO">GEO — Геометрия</option>
          <option value="VEC">VEC — Векторы</option>
          <option value="SPA">SPA — Геометрия в пространстве</option>
          <option value="MET">MET — Метрические соотношения</option>
          <option value="SPV">SPV — Векторы в пространстве</option>
          <option value="CTX">CTX — Контекст</option>
        </select>
      </div>

      <div class="mb-3">
        <label class="form-label">Контекст (может быть пустым)</label>
        <select name="context_id" id="contextSelect" class="form-select">
          <option value="">Без контекста</option>
        </select>
      </div>

      <div class="mb-3">
        <label class="form-label">Варианты ответов (до 8)</label>
        <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox" id="enableSuboptions">
          <label class="form-check-label" for="enableSuboptions">
            Включить подопции (для сложных вопросов с выпадающими списками)
          </label>
        </div>
        <div id="optionsContainer">
          <div class="option-group mb-2">
            <input type="text" class="form-control option-text" placeholder="Вариант 1">
          </div>
          <div class="option-group mb-2">
            <input type="text" class="form-control option-text" placeholder="Вариант 2">
          </div>
          <div class="option-group mb-2">
            <input type="text" class="form-control option-text" placeholder="Вариант 3">
          </div>
          <div class="option-group mb-2">
            <input type="text" class="form-control option-text" placeholder="Вариант 4">
          </div>
        </div>
        <button type="button" id="addOption" class="btn btn-sm btn-outline-primary mt-2">+ Добавить вариант</button>
      </div>

      <div class="mb-3">
        <label class="form-label">Фото (до 3)</label>
        <input type="file" id="photoInput" accept="image/*" multiple class="form-control">
        <div id="photoPreview" class="d-flex gap-2 mt-2 flex-wrap"></div>
      </div>

      <div class="d-flex gap-2">
        <button type="button" id="previewBtn" class="btn btn-secondary">Предпросмотр JSON</button>
        <button type="submit" class="btn btn-primary">Отправить</button>
      </div>

      <div id="status" class="mt-3"></div>
    </form>
  </div>

  <!-- Модальное окно кропа -->
  <div id="cropModal" class="crop-modal" style="display:none;">
    <div>
      <img id="cropImage" src="">
      <div class="text-center mt-3">
        <button id="cropSave" class="btn btn-success me-2">Обрезать</button>
        <button id="cropCancel" class="btn btn-secondary">Отмена</button>
      </div>
    </div>
  </div>

  <!-- Модальное окно предпросмотра JSON -->
  <div class="modal fade" id="jsonModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Предпросмотр JSON</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <pre id="jsonPreview"></pre>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const contextSelect = document.getElementById('contextSelect');
    const photoInput = document.getElementById('photoInput');
    const photoPreview = document.getElementById('photoPreview');
    const form = document.getElementById('questionForm');
    const status = document.getElementById('status');
    const addOptionBtn = document.getElementById('addOption');
    const previewBtn = document.getElementById('previewBtn');
    const enableSuboptionsCheckbox = document.getElementById('enableSuboptions');

    let cropper;
    let cropModal = document.getElementById('cropModal');
    let cropImage = document.getElementById('cropImage');
    let croppedFiles = [];

    // Загрузка контекстов
    fetch('https://math-app-production.up.railway.app/api/contexts')
      .then(res => res.json())
      .then(data => {
        data.forEach(ctx => {
          const opt = document.createElement('option');
          opt.value = ctx.id;
          opt.textContent = `${ctx.id} — ${ctx.title}`;
          contextSelect.appendChild(opt);
        });
      });

    // Переключение режима подопций
    enableSuboptionsCheckbox.addEventListener('change', () => {
      updateOptionsUI();
    });

    // Добавление вариантов ответов
    addOptionBtn.addEventListener('click', () => {
      const container = document.getElementById('optionsContainer');
      const count = container.querySelectorAll('.option-group').length;
      if (count >= 8) return alert('Максимум 8 вариантов');
      
      const optionGroup = createOptionGroup(count + 1);
      container.appendChild(optionGroup);
    });

    function createOptionGroup(index) {
      const group = document.createElement('div');
      group.className = 'option-group mb-2';
      
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'form-control option-text';
      input.placeholder = `Вариант ${index}`;
      
      group.appendChild(input);
      
      if (enableSuboptionsCheckbox.checked) {
        addSuboptionsToGroup(group);
      }
      
      return group;
    }

    function addSuboptionsToGroup(group) {
      const suboptionsContainer = document.createElement('div');
      suboptionsContainer.className = 'suboptions-container';
      
      const label = document.createElement('small');
      label.className = 'text-muted';
      label.textContent = 'Подопции (отметьте правильные):';
      suboptionsContainer.appendChild(label);
      
      // Добавляем 4 подопции по умолчанию
      for (let i = 0; i < 4; i++) {
        addSuboptionItem(suboptionsContainer, i + 1);
      }
      
      const addSuboptionBtn = document.createElement('button');
      addSuboptionBtn.type = 'button';
      addSuboptionBtn.className = 'btn btn-sm btn-outline-secondary mt-2';
      addSuboptionBtn.textContent = '+ Добавить подопцию';
      addSuboptionBtn.onclick = () => {
        const count = suboptionsContainer.querySelectorAll('.suboption-item').length;
        if (count >= 8) return alert('Максимум 8 подопций');
        addSuboptionItem(suboptionsContainer, count + 1);
      };
      
      suboptionsContainer.appendChild(addSuboptionBtn);
      group.appendChild(suboptionsContainer);
    }

    function addSuboptionItem(container, index) {
      const item = document.createElement('div');
      item.className = 'suboption-item';
      
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'form-control form-control-sm';
      input.placeholder = `Подопция ${index}`;
      
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.className = 'form-check-input';
      checkbox.title = 'Правильный ответ';
      
      const label = document.createElement('label');
      label.className = 'form-check-label ms-1';
      label.textContent = 'Правильно';
      
      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'btn btn-sm btn-outline-danger ms-2';
      removeBtn.textContent = '×';
      removeBtn.onclick = () => {
        if (container.querySelectorAll('.suboption-item').length > 1) {
          item.remove();
        } else {
          alert('Должна быть хотя бы одна подопция');
        }
      };
      
      item.appendChild(input);
      item.appendChild(checkbox);
      item.appendChild(label);
      item.appendChild(removeBtn);
      
      // Вставляем перед кнопкой "Добавить подопцию"
      const addBtn = container.querySelector('button');
      container.insertBefore(item, addBtn);
    }

    function updateOptionsUI() {
      const container = document.getElementById('optionsContainer');
      const groups = container.querySelectorAll('.option-group');
      
      groups.forEach(group => {
        const existingSuboptions = group.querySelector('.suboptions-container');
        
        if (enableSuboptionsCheckbox.checked && !existingSuboptions) {
          addSuboptionsToGroup(group);
        } else if (!enableSuboptionsCheckbox.checked && existingSuboptions) {
          existingSuboptions.remove();
        }
      });
    }

    // Обработка фото
    photoInput.addEventListener('change', e => {
      const files = Array.from(e.target.files);
      files.forEach(file => {
        if (croppedFiles.length >= 3) return alert('Максимум 3 фото!');
        croppedFiles.push(file);

        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        img.className = 'preview';
        img.title = 'Нажмите, чтобы обрезать';
        img.style.cursor = 'pointer';
        img.onclick = () => openCropModal(file, img);
        photoPreview.appendChild(img);
      });
    });

    function openCropModal(file, imgElement) {
      const reader = new FileReader();
      reader.onload = () => {
        cropImage.src = reader.result;
        cropModal.style.display = 'flex';
        cropper = new Cropper(cropImage, {
          aspectRatio: NaN,
          viewMode: 1,
          autoCropArea: 1
        });
        cropModal.dataset.fileName = file.name;
        cropModal.dataset.mimeType = file.type;
        cropModal.dataset.imgElementId = imgElement.src;
      };
      reader.readAsDataURL(file);
    }

    document.getElementById('cropCancel').onclick = () => {
      cropper.destroy();
      cropModal.style.display = 'none';
    };

    document.getElementById('cropSave').onclick = () => {
      const mimeType = cropModal.dataset.mimeType || 'image/png';
      cropper.getCroppedCanvas({
        imageSmoothingQuality: 'high'
      }).toBlob(blob => {
        const name = cropModal.dataset.fileName || 'photo.png';
        const oldSrc = cropModal.dataset.imgElementId;

        const previewImg = [...photoPreview.querySelectorAll('img')].find(i => i.src === oldSrc);
        if (previewImg) previewImg.src = URL.createObjectURL(blob);

        const index = croppedFiles.findIndex(f => f.name === name);
        if (index !== -1) croppedFiles[index] = new File([blob], name, { type: mimeType });

        cropper.destroy();
        cropModal.style.display = 'none';
      }, mimeType, 1);
    };

    // Предпросмотр JSON
    previewBtn.addEventListener('click', () => {
      const options = collectOptionsData();
      const data = {
        question: form.question.value,
        language: form.language.value,
        level: form.level.value,
        answer: form.answer.value,
        topic: form.topic.value,
        context_id: form.context_id.value || null,
        options
      };
      document.getElementById('jsonPreview').textContent = JSON.stringify(data, null, 2);
      new bootstrap.Modal(document.getElementById('jsonModal')).show();
    });

    function collectOptionsData() {
      const groups = document.querySelectorAll('#optionsContainer .option-group');
      const options = [];
      
      groups.forEach(group => {
        const optionText = group.querySelector('.option-text').value.trim();
        if (!optionText) return;
        
        const suboptionsContainer = group.querySelector('.suboptions-container');
        
        if (suboptionsContainer) {
          // Режим с подопциями
          const suboptions = [];
          const suboptionItems = suboptionsContainer.querySelectorAll('.suboption-item');
          
          suboptionItems.forEach(item => {
            const text = item.querySelector('input[type="text"]').value.trim();
            const correct = item.querySelector('input[type="checkbox"]').checked;
            
            if (text) {
              suboptions.push({ text, correct });
            }
          });
          
          if (suboptions.length > 0) {
            options.push({
              text: optionText,
              suboptions: suboptions
            });
          }
        } else {
          // Обычный режим
          options.push(optionText);
        }
      });
      
      return options;
    }

    // Отправка формы
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      status.textContent = 'Отправка...';

      const fd = new FormData();
      fd.append('question', form.question.value);
      fd.append('language', form.language.value);
      fd.append('level', form.level.value);
      fd.append('answer', form.answer.value);
      fd.append('topic', form.topic.value);

      if (form.context_id.value) fd.append('context_id', form.context_id.value);

      const options = collectOptionsData();
      fd.append('options', JSON.stringify(options));

      croppedFiles.forEach((file, i) => fd.append(`photo${i + 1}`, file, file.name));

      try {
        const res = await fetch('https://math-app-production.up.railway.app/api/questions', {
          method: 'POST',
          body: fd
        });

        if (!res.ok) {
          const err = await res.text();
          status.innerHTML = `<span class="text-danger">Ошибка: ${err}</span>`;
        } else {
          status.innerHTML = `<span class="text-success">✅ Успешно отправлено!</span>`;
          form.reset();
          photoPreview.innerHTML = '';
          croppedFiles = [];
        }
      } catch (err) {
        status.innerHTML = `<span class="text-danger">Ошибка: ${err}</span>`;
      }
    });
  </script>
</body>
</html>
