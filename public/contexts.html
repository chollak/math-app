<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Добавить Context</title>
  <link href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.css" rel="stylesheet"/>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f5f7fb;
      padding: 20px;
      color: #333;
      max-width: 700px;
      margin: auto;
    }
    h1 {
      text-align: center;
    }
    form {
      background: #fff;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    input, textarea, button {
      font-size: 16px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      cursor: pointer;
      background: #007bff;
      color: white;
      border: none;
      font-weight: bold;
    }
    button:hover {
      background: #0056b3;
    }
    .error {
      color: #d9534f;
      font-weight: 600;
    }
    .preview {
      white-space: pre-wrap;
      background: #f0f0f0;
      padding: 10px;
      border-radius: 8px;
      font-size: 14px;
      overflow-x: auto;
    }
    .photo-preview {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .photo-preview img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    #cropModal {
      display: none;
      position: fixed;
      z-index: 1000;
      inset: 0;
      background: rgba(0,0,0,0.7);
      align-items: center;
      justify-content: center;
    }
    #cropModalContent {
      background: white;
      padding: 20px;
      border-radius: 12px;
      max-width: 90%;
      max-height: 90%;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
    }
    #cropImage {
      max-width: 100%;
      max-height: 60vh;
    }
    #cropButtons {
      display: flex;
      gap: 10px;
    }
  </style>
</head>
<body>
  <h1>Добавить Context</h1>

  <form id="contextForm">
    <input type="text" id="title" placeholder="Введите заголовок" required />
    <textarea id="text" placeholder="Введите текст" required rows="4"></textarea>

    <label>Фото 1:</label>
    <input type="file" id="photo1" accept="image/*" />
    <label>Фото 2:</label>
    <input type="file" id="photo2" accept="image/*" />
    <label>Фото 3:</label>
    <input type="file" id="photo3" accept="image/*" />

    <div class="photo-preview" id="photoPreview"></div>

    <button type="button" id="previewBtn">Предпросмотр JSON</button>
    <button type="submit">Отправить</button>
  </form>

  <div id="errorMsg" class="error"></div>
  <div id="jsonPreview" class="preview" style="display:none;"></div>

  <!-- Модальное окно для кропа -->
  <div id="cropModal">
    <div id="cropModalContent">
      <img id="cropImage" alt="Crop" />
      <div id="cropButtons">
        <button id="cropSave">Сохранить</button>
        <button id="cropCancel">Отмена</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.js"></script>
  <script>
    const form = document.getElementById('contextForm');
    const errorMsg = document.getElementById('errorMsg');
    const jsonPreview = document.getElementById('jsonPreview');
    const previewBtn = document.getElementById('previewBtn');
    const photoInputs = ['photo1', 'photo2', 'photo3'].map(id => document.getElementById(id));
    const photoPreview = document.getElementById('photoPreview');

    const cropModal = document.getElementById('cropModal');
    const cropImage = document.getElementById('cropImage');
    const cropSave = document.getElementById('cropSave');
    const cropCancel = document.getElementById('cropCancel');
    let cropper = null;
    let currentFileInput = null;

    // === Функция для кропа ===
    photoInputs.forEach(input => {
      input.addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return;
        currentFileInput = input;
        const reader = new FileReader();
        reader.onload = () => {
          cropImage.src = reader.result;
          cropModal.style.display = 'flex';
          cropper = new Cropper(cropImage, { aspectRatio: NaN, viewMode: 1 });
        };
        reader.readAsDataURL(file);
      });
    });

    cropSave.addEventListener('click', () => {
      const canvas = cropper.getCroppedCanvas();
      canvas.toBlob(blob => {
        const file = new File([blob], "cropped.jpg", { type: "image/jpeg" });
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        currentFileInput.files = dataTransfer.files;
        showPreviews();
      }, 'image/jpeg');
      cropModal.style.display = 'none';
      cropper.destroy();
    });

    cropCancel.addEventListener('click', () => {
      cropModal.style.display = 'none';
      cropper.destroy();
    });

    // === Предпросмотр изображений ===
    function showPreviews() {
      photoPreview.innerHTML = '';
      photoInputs.forEach(input => {
        const file = input.files[0];
        if (file) {
          const img = document.createElement('img');
          img.src = URL.createObjectURL(file);
          photoPreview.appendChild(img);
        }
      });
    }

    // === Предпросмотр JSON ===
    previewBtn.addEventListener('click', () => {
      const data = {
        title: document.getElementById('title').value,
        text: document.getElementById('text').value,
      };
      jsonPreview.textContent = JSON.stringify(data, null, 2);
      jsonPreview.style.display = 'block';
    });

    // === Отправка формы ===
    form.addEventListener('submit', async e => {
      e.preventDefault();
      errorMsg.textContent = '';
      jsonPreview.style.display = 'none';

      const formData = new FormData();
      formData.append('title', document.getElementById('title').value);
      formData.append('text', document.getElementById('text').value);
      photoInputs.forEach((input, i) => {
        if (input.files[0]) formData.append(`photo${i+1}`, input.files[0]);
      });

      try {
        const response = await fetch('https://math-app-production.up.railway.app/api/contexts', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(errorText);
        }

        alert('Данные успешно отправлены!');
        form.reset();
        photoPreview.innerHTML = '';
      } catch (err) {
        errorMsg.textContent = 'Ошибка: ' + err.message;
      }
    });
  </script>
</body>
</html>
