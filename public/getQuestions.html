<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Вопросы — /api/questions</title>
  <style>
    :root{--bg:#f8fafc;--card:#fff;--muted:#6b7280;--accent:#0f172a}
    body{font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Arial;margin:0;background:var(--bg);color:var(--accent)}
    .container{max-width:960px;margin:20px auto;padding:16px}
    header{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:16px}
    h1{margin:0;font-size:20px}
    input[type=text]{flex:1;min-width:220px;padding:8px 10px;border-radius:8px;border:1px solid #d1d5db;background:#fff}
    .list{display:flex;flex-direction:column;gap:10px}
    .card{background:var(--card);border-radius:10px;padding:10px 14px;box-shadow:0 2px 8px rgba(0,0,0,0.04);display:flex;flex-direction:column;gap:6px}
    .meta{font-size:12px;color:var(--muted)}
    .title{font-weight:600;margin:2px 0}
    .options{display:flex;gap:6px;flex-wrap:wrap}
    .option{background:#f3f4f6;padding:4px 6px;border-radius:6px;font-size:13px}
    .answer{display:inline-block;padding:4px 6px;border-radius:6px;background:#e6fffa;border:1px solid #bff0e7;margin-left:4px;font-size:13px;font-weight:600}
    .photos{display:flex;gap:6px;flex-wrap:wrap;margin-top:4px}
    .photos img{width:100px;height:100px;object-fit:cover;border-radius:6px;cursor:pointer;border:1px solid #e6eef6}
    .context{font-size:12px;color:var(--muted)}
    .empty{padding:20px;text-align:center;color:var(--muted)}
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,0.6);z-index:50}
    .modal.open{display:grid}
    .modal img{max-width:90vw;max-height:90vh;border-radius:8px;box-shadow:0 8px 40px rgba(2,6,23,0.6)}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Список вопросов</h1>
      <input id="search" type="text" placeholder="Поиск..." />
    </header>
    <div id="status" class="meta">Загрузка...</div>
    <main class="list" id="list"></main>
  </div>

  <div id="modal" class="modal" role="dialog" aria-hidden="true">
    <img id="modalImg" src="" alt="photo preview" />
  </div>

  <script>
    const API_BASE = 'https://math-app-production.up.railway.app';
    const listEl = document.getElementById('list');
    const status = document.getElementById('status');
    const searchInput = document.getElementById('search');
    const modal = document.getElementById('modal');
    const modalImg = document.getElementById('modalImg');
    let allData = [];

    modal.addEventListener('click', ()=>{modal.classList.remove('open'); modal.setAttribute('aria-hidden','true');});
    searchInput.addEventListener('input', ()=>renderList(searchInput.value));

    async function load(){
      try{
        const res = await fetch(`${API_BASE}/api/questions`);
        if(!res.ok) throw new Error(res.status + ' ' + res.statusText);
        const data = await res.json();
        allData = Array.isArray(data) ? data : [];
        status.textContent = `Получено ${allData.length} вопросов`;
        renderList();
      }catch(err){
        status.textContent = 'Ошибка: ' + err.message;
        listEl.innerHTML = '<div class="empty">Не удалось получить данные</div>';
        console.error(err);
      }
    }

    function renderList(filter=''){
      const query = filter.toLowerCase();
      const filtered = allData.filter(q =>
        Object.values(q).some(v => typeof v === 'string' && v.toLowerCase().includes(query)) ||
        (q.options && q.options.some(o => o.toLowerCase().includes(query))) ||
        (q.context && (q.context.text?.toLowerCase().includes(query) || q.context.title?.toLowerCase().includes(query)))
      );

      listEl.innerHTML = '';
      if(filtered.length === 0){
        listEl.innerHTML = '<div class="empty">Ничего не найдено</div>';
        return;
      }
      filtered.sort((a,b)=>(a.id||0)-(b.id||0));
      for(const q of filtered){
        listEl.appendChild(renderCard(q));
      }
    }

    function renderCard(q){
      const card = document.createElement('article');
      card.className = 'card';

      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.textContent = `ID: ${q.id ?? '-'} | ${q.language} | Level ${q.level} | ${q.topic}`;

      const title = document.createElement('div');
      title.className = 'title';
      title.textContent = q.question || '(пустой вопрос)';

      const optionsWrap = document.createElement('div');
      optionsWrap.className = 'options';
      if(Array.isArray(q.options)){
        q.options.forEach((opt, idx)=>{
          const el = document.createElement('div');
          el.className='option';
          el.textContent = String.fromCharCode(65+idx)+') '+opt;
          optionsWrap.appendChild(el);
        });
      }

      const answerEl = document.createElement('div');
      answerEl.innerHTML = '<strong>Ответ:</strong> <span class="answer">' + escape(q.answer || '') + '</span>';

      const contextEl = document.createElement('div');
      if(q.context){
        contextEl.className = 'context';
        contextEl.textContent = `Context: ${q.context.title || ''} — ${q.context.text || ''}`;
      }

      const photosWrap = document.createElement('div');
      photosWrap.className = 'photos';
      if(Array.isArray(q.photos) && q.photos.length){
        q.photos.forEach(filename=>{
          const img = document.createElement('img');
          const src = API_BASE + '/api/files/' + encodeURIComponent(filename);
          img.src = src;
          img.alt = filename;
          img.addEventListener('click', ()=>{ modalImg.src = src; modal.classList.add('open'); modal.setAttribute('aria-hidden','false'); });
          photosWrap.appendChild(img);
        });
      }

      card.append(meta, title, optionsWrap, answerEl, contextEl, photosWrap);
      return card;
    }

    function escape(s){ if(s==null) return ''; return String(s).replace(/[&<>\"]+/g, ch=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[ch]||ch)); }

    load(); // auto-load on start
  </script>
</body>
</html>
