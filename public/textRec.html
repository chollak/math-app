
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Math OCR Bot</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f9fafc;
    }

    h2 {
      color: #2c3e50;
    }

    #preview {
      max-width: 600px;
      display: none;
      margin: 15px 0;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    pre {
      background: #f4f6f9;
      padding: 12px;
      border-radius: 8px;
      white-space: pre-wrap;
      font-size: 15px;
      border: 1px solid #e1e4e8;
    }

    button {
      margin: 6px 4px;
      padding: 10px 18px;
      border-radius: 8px;
      cursor: pointer;
      border: none;
      font-size: 15px;
      background: #3498db;
      color: white;
      font-weight: 600;
      transition: background 0.25s, transform 0.15s;
    }

    button:hover {
      background: #2980b9;
      transform: translateY(-2px);
    }

    button:active {
      transform: translateY(0);
    }

    select, input[type="text"] {
      padding: 6px 10px;
      margin: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    .copy-status {
      display: none;
      color: green;
      font-size: 13px;
      margin-left: 10px;
    }

    .excel-line {
      background: #eef6ff;
      padding: 8px;
      margin: 6px 0;
      border-radius: 6px;
      font-family: monospace;
      border: 1px solid #cce0ff;
    }

    h3 {
      color: #34495e;
    }

    h4 {
      margin-top: 10px;
      color: #2c3e50;
    }
  </style>
</head>
<body>
  <h2>üì∑ Universal OCR Bot No Latex</h2>

  <input type="file" id="fileInput" accept="image/*" multiple>
  <br><br>
  <img id="preview">

  <br>
  <button onclick="prevImage()">‚¨Ö –ü—Ä–µ–¥—ã–¥—É—â–µ–µ</button>
  <button onclick="nextImage()">‚û° –°–ª–µ–¥—É—é—â–µ–µ</button>

  <br><br>
  <label>–Ø–∑—ã–∫:</label>
  <select id="langSelect">
    <option value="ru">–†—É—Å—Å–∫–∏–π</option>
    <option value="kz">“ö–∞–∑–∞“õ—à–∞</option>
  </select>

  <label>–°–ª–æ–∂–Ω–æ—Å—Ç—å:</label>
  <select id="levelSelect">
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4">4</option>
    <option value="5">5</option>
  </select>

  <label>–ú–æ–¥–µ–ª—å:</label>
  <select id="modelSelect">
    <option value="gpt-4o-mini" selected>gpt-4o-mini</option>
    <option value="gpt-4o">gpt-4o</option>
    <option value="gpt-4">gpt-4</option>
    <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
    <option value="gpt-5">gpt-5</option>
   
  </select>

  <br><br>
  <label>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:</label>
  <input type="text" id="answerInput" placeholder="A, B, C..." style="width: 80px;">
  <button onclick="detectAnswer()">ü§ñ –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç</button>
  <span id="aiStatus" style="display:none; color:blue;">‚è≥ AI –¥—É–º–∞–µ—Ç...</span>

  <br><br>
  <button onclick="processImage()">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>

  <div id="result"></div>

  <script>
    let OPENAI_API_KEY = null; // Will be loaded from config
    let selectedFiles = [];
    let currentIndex = 0;
    let lastExtractedText = "";

    // Load configuration on page load
    async function loadConfig() {
      try {
        const response = await fetch('/config');
        const config = await response.json();
        
        if (config.openaiApiKey) {
          OPENAI_API_KEY = config.openaiApiKey;
          console.log('‚úÖ OpenAI API key loaded successfully');
        } else {
          console.error('‚ùå OpenAI API key not configured');
          alert('–û—à–∏–±–∫–∞: OpenAI API –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.');
        }
      } catch (error) {
        console.error('‚ùå Failed to load config:', error);
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω.');
      }
    }

    // Initialize on page load
    window.addEventListener('DOMContentLoaded', loadConfig);

    // --- –ø—Ä–µ–≤—å—é ---
    document.getElementById("fileInput").addEventListener("change", function() {
      selectedFiles = Array.from(this.files);
      currentIndex = 0;
      showPreview();
    });

    function showPreview() {
      if (!selectedFiles.length) return;
      const file = selectedFiles[currentIndex];
      const reader = new FileReader();
      reader.onload = e => {
        const img = document.getElementById("preview");
        img.src = e.target.result;
        img.style.display = "block";
      };
      reader.readAsDataURL(file);
    }

    function prevImage() {
      if (!selectedFiles.length) return;
      currentIndex = (currentIndex - 1 + selectedFiles.length) % selectedFiles.length;
      showPreview();
    }

    function nextImage() {
      if (!selectedFiles.length) return;
      currentIndex = (currentIndex + 1) % selectedFiles.length;
      showPreview();
    }

    // --- –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è ---
    function preprocessImage(file, callback) {
      const img = new Image();
      const reader = new FileReader();

      reader.onload = e => {
        img.src = e.target.result;
      };

      img.onload = () => {
        const maxWidth = 1200;
        const scale = Math.min(maxWidth / img.width, 1);
        const canvas = document.createElement("canvas");
        canvas.width = img.width * scale;
        canvas.height = img.height * scale;

        const ctx = canvas.getContext("2d");
        ctx.filter = "contrast(120%)";
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

        canvas.toBlob(
          blob => {
            const reader2 = new FileReader();
            reader2.onloadend = () => {
              const base64 = reader2.result.split(",")[1];
              callback(base64);
            };
            reader2.readAsDataURL(blob);
          },
          "image/jpeg",
          0.8
        );
      };

      reader.readAsDataURL(file);
    }

    // --- –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ ---
    function renderResult(correctAnswer) {
      if (!lastExtractedText) return;

      const level = document.getElementById("levelSelect").value;
      let resultHtml = "";
      let allExcelLines = [];

      const regex = /\[(–û—Ä–∏–≥–∏–Ω–∞–ª|–ü–µ—Ä–µ–≤–æ–¥):\s*(–†—É—Å—Å–∫–∏–π|“ö–∞–∑–∞“õ—à–∞)\]([\s\S]*?)(?=\[(?:–û—Ä–∏–≥–∏–Ω–∞–ª|–ü–µ—Ä–µ–≤–æ–¥):|$)/g;
      let match;

      while ((match = regex.exec(lastExtractedText)) !== null) {
        const type = match[1];
        const blockLang = match[2];
        const content = match[3].trim();

        const lines = content.split("\n").filter(line => line.trim() !== "");
        const question = lines[0] || "";
        const answers = lines.slice(1).map(line => line.replace(/^[A-Ja-j]\)\s*/, ""));

        function sanitize(str) {
          return str
        }

        const excelLine = [
          blockLang,
          correctAnswer || "-",
          level,
          sanitize(question),
          ...answers.map(a => sanitize(a))
        ].join("\t");

        allExcelLines.push(excelLine);

        resultHtml += `
          <h3>üìñ ${type}: ${blockLang}</h3>
          <pre>${content}</pre>
          <h4>üìä Excel-—Å—Ç—Ä–æ–∫–∞ (${type}: ${blockLang})</h4>
          <div class="excel-line">${excelLine}</div>
          <button onclick="copyExcel(this, \`${excelLine}\`)">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å Excel (${type}: ${blockLang})</button>
          <div class="copy-status">‚úî –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ</div>
        `;
      }

      const allLines = allExcelLines.join("\n");
      resultHtml =
        `<button onclick="copyAllExcel(\`${allLines}\`)">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤—Å—ë (${allExcelLines.length} —Å—Ç—Ä–æ–∫)</button>
         <div id="allCopyStatus" class="copy-status">‚úî –í—Å–µ —Å—Ç—Ä–æ–∫–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã</div>`
        + resultHtml;

      document.getElementById("result").innerHTML = resultHtml;
    }

    // --- –æ—Ç–ø—Ä–∞–≤–∫–∞ ---
    async function processImage() {
      if (!selectedFiles.length) return alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª!");
      if (!OPENAI_API_KEY) return alert("OpenAI API –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!");
      
      const file = selectedFiles[currentIndex];
      const userLang = document.getElementById("langSelect").value;
      const correctAnswer = document.getElementById("answerInput").value.trim();
      const model = document.getElementById("modelSelect").value;

      preprocessImage(file, async (base64) => {
            let prompt = userLang === "ru"
      ? `–ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.
1. –ò–∑–≤–ª–µ–∫–∏ –≤–æ–ø—Ä–æ—Å –∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤ –≤ —Ç–µ–∫—Å—Ç.
2. –í –≤–æ–ø—Ä–æ—Å–µ –∏ –≤–∞—Ä–∏–∞–Ω—Ç–∞—Ö –Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –≤–µ–¥—É—â–∏–µ –º–∞—Ä–∫–µ—Ä—ã –≤—Ä–æ–¥–µ:
    "1.", "1)", "–ê)", "–ê.", "–∞)", "–∞.", "A)", "A.", "a)", "a.", "-", "‚Ä¢", –∞ —Ç–∞–∫–∂–µ –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã.
3. –ü–µ—Ä–µ–≤–µ–¥–∏ —ç—Ç–æ—Ç –∂–µ –≤–æ–ø—Ä–æ—Å –∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã –Ω–∞ –∫–∞–∑–∞—Ö—Å–∫–∏–π —è–∑—ã–∫.

–§–æ—Ä–º–∞—Ç:

[–û—Ä–∏–≥–∏–Ω–∞–ª: –†—É—Å—Å–∫–∏–π]
<–≤–æ–ø—Ä–æ—Å + –≤–∞—Ä–∏–∞–Ω—Ç—ã>

[–ü–µ—Ä–µ–≤–æ–¥: “ö–∞–∑–∞“õ—à–∞]
<—Å“±—Ä–∞“õ + –Ω“±—Å“õ–∞–ª–∞—Ä>`
      : `–ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –Ω–∞ –∫–∞–∑–∞—Ö—Å–∫–æ–º —è–∑—ã–∫–µ.
1. –ò–∑–≤–ª–µ–∫–∏ —Å“±—Ä–∞“õ –∂”ô–Ω–µ –Ω“±—Å“õ–∞–ª–∞—Ä –≤ —Ç–µ–∫—Å—Ç.
2. –£–¥–∞–ª–∏ –≤–µ–¥—É—â–∏–µ –º–∞—Ä–∫–µ—Ä—ã –≤—Ä–æ–¥–µ:
   "1.", "1)", "–ê)", "–ê.", "–∞)", "–∞.", "A)", "A.", "a)", "a.", "-", "‚Ä¢", –∞ —Ç–∞–∫–∂–µ –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã.
—ñ. –ü–µ—Ä–µ–≤–µ–¥–∏ —ç—Ç–æ—Ç –∂–µ –≤–æ–ø—Ä–æ—Å –∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã –Ω–∞ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫.

–§–æ—Ä–º–∞—Ç:

[–û—Ä–∏–≥–∏–Ω–∞–ª: “ö–∞–∑–∞“õ—à–∞]
<—Å“±—Ä–∞“õ + –Ω“±—Å“õ–∞–ª–∞—Ä>

[–ü–µ—Ä–µ–≤–æ–¥: –†—É—Å—Å–∫–∏–π]
<–≤–æ–ø—Ä–æ—Å + –≤–∞—Ä–∏–∞–Ω—Ç—ã>`;
        
        document.getElementById("result").innerHTML = "‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞...";

        const response = await fetch("https://api.openai.com/v1/chat/completions", {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + OPENAI_API_KEY,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            model: model,
            messages: [
              { role: "system", content: "–¢—ã –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –∑–∞–¥–∞–Ω–∏–π. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Ç–æ—á–Ω–æ –∏–∑–≤–ª–µ–∫–∞—Ç—å —Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–æ–≤ –∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, –æ—á–∏—â–∞—Ç—å –µ–≥–æ –æ—Ç –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤ –∏ –º–∞—Ä–∫–µ—Ä–æ–≤, –Ω–µ –¥–æ–±–∞–≤–ª—è—è –Ω–∏—á–µ–≥–æ –æ—Ç —Å–µ–±—è. –¢—ã –Ω–µ —Ä–µ—à–∞–µ—à—å –∑–∞–¥–∞–Ω–∏—è, –Ω–µ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ—à—å –∏ –Ω–µ –∏–∑–º–µ–Ω—è–µ—à—å —Å–º—ã—Å–ª. –†–∞–±–æ—Ç–∞–π –∞–∫–∫—É—Ä–∞—Ç–Ω–æ —Å —Ç–µ–∫—Å—Ç–∞–º–∏ –ø–æ –ª—é–±—ã–º –ø—Ä–µ–¥–º–µ—Ç–∞–º." },
              {
                role: "user",
                content: [
                  { type: "text", text: prompt },
                  { type: "image_url", image_url: { url: `data:image/jpeg;base64,${base64}` } }
                ]
              }
            ],
            temperature: 0.2
          })
        });

        const data = await response.json();

        const text =
          data.choices?.[0]?.message?.content ||
          data.choices?.[0]?.message?.content?.[0]?.text ||
          "‚ö† –û—à–∏–±–∫–∞: –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏";

        lastExtractedText = text;
        renderResult(correctAnswer);
      });
    }

    // --- AI –≤—ã–±–æ—Ä –æ—Ç–≤–µ—Ç–∞ ---
    async function detectAnswer() {
      if (!lastExtractedText) return alert("–°–Ω–∞—á–∞–ª–∞ –æ–±—Ä–∞–±–æ—Ç–∞–π—Ç–µ –∑–∞–¥–∞—á—É!");
      if (!OPENAI_API_KEY) return alert("OpenAI API –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!");
      
      const status = document.getElementById("aiStatus");
      status.style.display = "inline";
      const model = document.getElementById("modelSelect").value;

      const response = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + OPENAI_API_KEY,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          model: model,
          messages: [
            { role: "system", content: "–¢—ã –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –û–ø—Ä–µ–¥–µ–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç." },
            { role: "user", content: `–í–æ—Ç –∑–∞–¥–∞—á–∞:\n${lastExtractedText}\n\n–û—Ç–≤–µ—Ç—å —Ç–æ–ª—å–∫–æ –±—É–∫–≤–æ–π (A, B, C, D...).` }
          ],
          temperature: 0
        })
      });

      const data = await response.json();
      const aiAnswer =
        data.choices?.[0]?.message?.content?.trim() ||
        data.choices?.[0]?.message?.content?.[0]?.text?.trim() ||
        "";

      const cleanAnswer = aiAnswer.replace(/[^A-J]/gi, "");
      document.getElementById("answerInput").value = cleanAnswer;
      status.style.display = "none";

      renderResult(cleanAnswer);
    }

    // --- –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ ---
    function copyExcel(button, line) {
      navigator.clipboard.writeText(line).then(() => {
        const status = button.nextElementSibling;
        status.style.display = "block";
        setTimeout(() => status.style.display = "none", 2000);
      });
    }

    function copyAllExcel(allLines) {
      navigator.clipboard.writeText(allLines).then(() => {
        const status = document.getElementById("allCopyStatus");
        status.style.display = "block";
        setTimeout(() => status.style.display = "none", 2000);
      });
    }
  </script>
</body>
</html>
