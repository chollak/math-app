<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Math OCR Bot</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f9fafc;
    }

    h2 {
      color: #2c3e50;
    }

    #preview {
      max-width: 600px;
      display: none;
      margin: 15px 0;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    pre {
      background: #f4f6f9;
      padding: 12px;
      border-radius: 8px;
      white-space: pre-wrap;
      font-size: 15px;
      border: 1px solid #e1e4e8;
    }

    button {
      margin: 6px 4px;
      padding: 10px 18px;
      border-radius: 8px;
      cursor: pointer;
      border: none;
      font-size: 15px;
      background: #3498db;
      color: white;
      font-weight: 600;
      transition: background 0.25s, transform 0.15s;
    }

    button:hover {
      background: #2980b9;
      transform: translateY(-2px);
    }

    button:active {
      transform: translateY(0);
    }

    select, input[type="text"] {
      padding: 6px 10px;
      margin: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    .copy-status {
      display: none;
      color: green;
      font-size: 13px;
      margin-left: 10px;
    }

    .excel-line {
      background: #eef6ff;
      padding: 8px;
      margin: 6px 0;
      border-radius: 6px;
      font-family: monospace;
      border: 1px solid #cce0ff;
    }

    h3 {
      color: #34495e;
    }

    h4 {
      margin-top: 10px;
      color: #2c3e50;
    }
  </style>
</head>
<body>
  <h2>üì∑ Universal OCR Bot No Latex</h2>

  <input type="file" id="fileInput" accept="image/*" multiple>
  <br><br>
  <img id="preview">

  <br>
  <button onclick="prevImage()">‚¨Ö –ü—Ä–µ–¥—ã–¥—É—â–µ–µ</button>
  <button onclick="nextImage()">‚û° –°–ª–µ–¥—É—é—â–µ–µ</button>

  <br><br>
  <label>–Ø–∑—ã–∫:</label>
  <select id="langSelect">
    <option value="ru">–†—É—Å—Å–∫–∏–π</option>
    <option value="kz">“ö–∞–∑–∞“õ—à–∞</option>
  </select>

  <label>–°–ª–æ–∂–Ω–æ—Å—Ç—å:</label>
  <select id="levelSelect">
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4">4</option>
    <option value="5">5</option>
  </select>

  <label>–ú–æ–¥–µ–ª—å:</label>
  <select id="modelSelect">
    <option value="gpt-4o-mini" selected>gpt-4o-mini</option>
    <option value="gpt-4o">gpt-4o</option>
    <option value="gpt-4">gpt-4</option>
    <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
    <option value="gpt-5">gpt-5</option>
  </select>

  <br><br>
  <label>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:</label>
  <input type="text" id="answerInput" placeholder="A, B, C..." style="width: 80px;">
  <button onclick="detectAnswer()">ü§ñ –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç</button>
  <span id="aiStatus" style="display:none; color:blue;">‚è≥ AI –¥—É–º–∞–µ—Ç...</span>

  <br><br>
  <button onclick="processImage()">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>

  <div id="result"></div>

  <script>
    let OPENAI_API_KEY = null;
    let selectedFiles = [];
    let currentIndex = 0;
    let lastExtractedText = "";

    async function loadConfig() {
      try {
        const response = await fetch('/config');
        const config = await response.json();

        if (config.openaiApiKey) {
          OPENAI_API_KEY = config.openaiApiKey;
        } else {
          alert('–û—à–∏–±–∫–∞: API –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω.');
        }
      } catch (e) {
        alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.");
      }
    }

    window.addEventListener('DOMContentLoaded', loadConfig);

    document.getElementById("fileInput").addEventListener("change", function() {
      selectedFiles = Array.from(this.files);
      currentIndex = 0;
      showPreview();
    });

    function showPreview() {
      if (!selectedFiles.length) return;
      const file = selectedFiles[currentIndex];
      const reader = new FileReader();
      reader.onload = e => {
        const img = document.getElementById("preview");
        img.src = e.target.result;
        img.style.display = "block";
      };
      reader.readAsDataURL(file);
    }

    function prevImage() {
      if (!selectedFiles.length) return;
      currentIndex = (currentIndex - 1 + selectedFiles.length) % selectedFiles.length;
      showPreview();
    }

    function nextImage() {
      if (!selectedFiles.length) return;
      currentIndex = (currentIndex + 1) % selectedFiles.length;
      showPreview();
    }

    function preprocessImage(file, callback) {
      const img = new Image();
      const reader = new FileReader();

      reader.onload = e => { img.src = e.target.result; };

      img.onload = () => {
        const maxWidth = 1200;
        const scale = Math.min(maxWidth / img.width, 1);
        const canvas = document.createElement("canvas");
        canvas.width = img.width * scale;
        canvas.height = img.height * scale;

        const ctx = canvas.getContext("2d");
        ctx.filter = "contrast(120%)";
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

        canvas.toBlob(blob => {
          const reader2 = new FileReader();
          reader2.onloadend = () => {
            const base64 = reader2.result.split(",")[1];
            callback(base64);
          };
          reader2.readAsDataURL(blob);
        }, "image/jpeg", 0.8);
      };

      reader.readAsDataURL(file);
    }

    /* ------------------------------
       –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø renderResult
       ------------------------------ */
    function renderResult(correctAnswer) {
      if (!lastExtractedText) return;

      const level = document.getElementById("levelSelect").value;
      const resultContainer = document.getElementById("result");
      resultContainer.innerHTML = "";

      const regex = /\[(–û—Ä–∏–≥–∏–Ω–∞–ª|–ü–µ—Ä–µ–≤–æ–¥):\s*(–†—É—Å—Å–∫–∏–π|“ö–∞–∑–∞“õ—à–∞)\]([\s\S]*?)(?=\[(?:–û—Ä–∏–≥–∏–Ω–∞–ª|–ü–µ—Ä–µ–≤–æ–¥):|$)/g;
      let match;

      while ((match = regex.exec(lastExtractedText)) !== null) {
        const type = match[1];
        const lang = match[2];
        const content = match[3].trim();

        const header = document.createElement("h3");
        header.textContent = `${type}: ${lang}`;
        resultContainer.appendChild(header);

        const pre = document.createElement("pre");
        pre.textContent = content; // <-- –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ö–ê–ö –¢–ï–ö–°–¢
        resultContainer.appendChild(pre);

        const excelBlock = document.createElement("pre");
        excelBlock.textContent = `${lang}\t${correctAnswer || "-"}\t${level}\t${content}`;
        resultContainer.appendChild(excelBlock);
      }

      if (!found) {
    const header = document.createElement("h3");
    header.textContent = "–†–µ–∑—É–ª—å—Ç–∞—Ç";
    resultContainer.appendChild(header);

    const pre = document.createElement("pre");
    pre.textContent = lastExtractedText;
    resultContainer.appendChild(pre);
  }
    }

    /* –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ ‚Äî –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô */

    async function processImage() {
      if (!selectedFiles.length) return alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª!");

      const file = selectedFiles[currentIndex];
      const userLang = document.getElementById("langSelect").value;
      const correctAnswer = document.getElementById("answerInput").value.trim();
      const model = document.getElementById("modelSelect").value;

      preprocessImage(file, async (base64) => {
        let prompt = userLang === "ru"
            ? `–¢—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—à—å —ç–∫–∑–∞–º–µ–Ω–∞—Ü–∏–æ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–µ...
(—Ç–≤–æ–π –¥–ª–∏–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Ç—É—Ç –æ—Å—Ç–∞—ë—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)`
            : `...`;

        document.getElementById("result").innerHTML = "‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞...";

        const response = await fetch("https://api.openai.com/v1/chat/completions", {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + OPENAI_API_KEY,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            model: model,
            messages: [
              { role: "system", content: "..." },
              {
                role: "user",
                content: [
                  { type: "text", text: prompt },
                  { type: "image_url", image_url: { url: `data:image/jpeg;base64,${base64}` } }
                ]
              }
            ],
            temperature: 0.2
          })
        });

        const data = await response.json();
        lastExtractedText = data.choices?.[0]?.message?.content || "‚ö† –û—à–∏–±–∫–∞: –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç";

        renderResult(correctAnswer);
      });
    }

    async function detectAnswer() {
      if (!lastExtractedText) return alert("–°–Ω–∞—á–∞–ª–∞ –æ–±—Ä–∞–±–æ—Ç–∞–π—Ç–µ –∑–∞–¥–∞—á—É!");

      const status = document.getElementById("aiStatus");
      status.style.display = "inline";

      const model = document.getElementById("modelSelect").value;

      const response = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + OPENAI_API_KEY,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          model: model,
          messages: [
            { role: "system", content: "–û–ø—Ä–µ–¥–µ–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç." },
            { role: "user", content: lastExtractedText }
          ],
          temperature: 0
        })
      });

      const data = await response.json();
      const aiAns = data.choices?.[0]?.message?.content || "";
      const clean = aiAns.replace(/[^A-J]/gi, "");

      document.getElementById("answerInput").value = clean;
      status.style.display = "none";

      renderResult(clean);
    }

    function copyExcel(button, line) {
      navigator.clipboard.writeText(line);
    }

    function copyAllExcel(lines) {
      navigator.clipboard.writeText(lines);
    }
  </script>
</body>
</html>
