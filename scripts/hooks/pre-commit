#!/bin/bash

# Pre-commit hook –¥–ª—è –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è Postman –∫–æ–ª–ª–µ–∫—Ü–∏–∏
# –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ –≤–µ—Ç–∫–µ main –∏ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö —Ä–æ—É—Ç–æ–≤

# –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –≤–µ—Ç–∫—É
current_branch=$(git branch --show-current)

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ –≤–µ—Ç–∫–µ main
if [ "$current_branch" != "main" ]; then
    # –í –¥—Ä—É–≥–∏—Ö –≤–µ—Ç–∫–∞—Ö –ø—Ä–æ—Å—Ç–æ –∑–∞–≤–µ—Ä—à–∞–µ–º —É—Å–ø–µ—à–Ω–æ –±–µ–∑ –¥–µ–π—Å—Ç–≤–∏–π
    exit 0
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª–∞—Ö —Ä–æ—É—Ç–æ–≤
routes_changed=false
if git diff --cached --name-only | grep -q "src/routes/"; then
    routes_changed=true
elif git diff --cached --name-only | grep -q "src/controllers/"; then
    routes_changed=true
elif git diff --cached --name-only | grep -q "src/models/"; then
    routes_changed=true
fi

# –ï—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ API –Ω–µ—Ç, –∑–∞–≤–µ—Ä—à–∞–µ–º –±–µ–∑ –¥–µ–π—Å—Ç–≤–∏–π
if [ "$routes_changed" = false ]; then
    exit 0
fi

echo "üîÑ –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ API —Ä–æ—É—Ç–∞—Ö..."
echo "üìã –û–±–Ω–æ–≤–ª—è–µ–º Postman –∫–æ–ª–ª–µ–∫—Ü–∏—é –¥–ª—è –≤–µ—Ç–∫–∏ main..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Node.js –∏ npm
if ! command -v npm &> /dev/null; then
    echo "‚ùå npm –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ Postman –∫–æ–ª–ª–µ–∫—Ü–∏–∏."
    exit 0
fi

# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—É—é –∫–æ–ª–ª–µ–∫—Ü–∏—é
if npm run postman:generate --silent; then
    # –î–æ–±–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—É—é –∫–æ–ª–ª–µ–∫—Ü–∏—é –≤ –∫–æ–º–º–∏—Ç
    git add postman/collections/math-app-api.postman_collection.json
    echo "‚úÖ Postman –∫–æ–ª–ª–µ–∫—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –∫–æ–º–º–∏—Ç"
else
    echo "‚ö†Ô∏è  –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Postman –∫–æ–ª–ª–µ–∫—Ü–∏–∏, –Ω–æ –∫–æ–º–º–∏—Ç –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è"
    # –ù–µ –±–ª–æ–∫–∏—Ä—É–µ–º –∫–æ–º–º–∏—Ç –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
fi

echo "üöÄ –ì–æ—Ç–æ–≤–æ! –ö–æ–º–º–∏—Ç –±—É–¥–µ—Ç –≤–∫–ª—é—á–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—É—é Postman –∫–æ–ª–ª–µ–∫—Ü–∏—é"
exit 0